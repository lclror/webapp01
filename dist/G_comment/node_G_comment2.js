function process(e,t,n){var r=function(r,i,s){var o=r.params.id;e("div#comment>span").text(o);var u=r.session.adminlogin;for(var a in n)n[a]=ObjectId(o);t.find(n).sort({time:1}).toArray(function(t,n){var r="";for(var i in n){var o='<img src="../../../img/user/user.jpg"/>',a="<p>"+n[i].content+"</p>",f=n[i]._id,l='<a  name="'+f+'">回复</a>',c=n[i].form_user,h="";u&&u.username==c&&(h='<span id="'+f+'" name="0"> 删除</span>',l="");var p="<h4>"+c+" "+h+"</h4>",d=n[i].reply,v="";for(var m in d){var g="<span>回复-"+d[m].to+" : </span>",y=d[m].from,b="<p>"+g+d[m].content+"</p>",w='<a  name="'+f+'">回复</a>',E=d[m].time,S="";u&&u.username==y&&(S='<span id="'+f+'" name="'+E+'"> 删除</span>',w="");var x="<h4>"+y+" "+S+"</h4>",T="<div>"+o+x+b+w+"</div>";v+=T}var N="<li>"+o+p+a+l+v+"</li>";r+=N}e("div#comment>ul.ul1").html(r),s()})};return r}function ajax_comment(e,t,n){e.post(t,function(e,t){var r=e.body.book_id,i=e.body.content,s=(new Date).toLocaleString(),o=e.body.comment_id,u=e.body.to,a=e.session.adminlogin;if(a){var f=a.username;if(o==0){var l={book_id:ObjectId(r),form_user:f,content:i,time:s,reply:[]};n.save(l,function(e,n){e?t.send({status:"error"}):(console.log("评论提交成功："+n),t.send({status:"comment",form:a.username}))})}else{var c={from:a.username,to:u,content:i,time:s};n.findAndModify({_id:ObjectId(o)},[],{$push:{reply:c}},function(e,n){e?t.send({status:"error"}):(console.log("回复提交成功："),t.send({status:"reply",form:a.username}))})}}else console.log(o),t.send({status:"noSession"})})}function ajax_comment_del(e,t,n){e.post(t,function(e,t){var r=e.body.comment_id,i=e.body.time;i==0?n.remove({_id:ObjectId(r)},function(e){e?t.send({status:"error"}):t.send({status:"success"})}):n.findAndModify({_id:ObjectId(r)},[],{$pull:{reply:{time:i}}},function(e,n){e||t.send({status:"success"})})})}var mongoskin=require("mongoskin"),ObjectId=mongoskin.ObjectId,html='	<div id="comment">		<span></span>		<h1>评论区</h1>		<ul class="ul1">			<li>				<img src="../../../img/user/user.jpg"/>				<h4>test01 <span> 删除</span></h4>				<p>content! content! content!</p>				<a href="#textarea" name="oid">回复</a>				<div>					<img src="../../../img/user/user.jpg"/>					<h4>test01 <span> 删除</span></h4>					<p> <span>回复-user2 : </span>content! </p>					<a href="#textarea" name="oid">回复</a>				</div>			</li>			<li>				<img src="../../../img/user/user.jpg"/>				<h4>user01</h4>				<p>nice!</p>				<a href="#textarea" name="oid">回复</a>			</li>		</ul>		<textarea id="textarea"  cols="60" rows="4"></textarea><br/>		<button class="btn-opacity" type="button">submit</button>	</div>';exports.html=html,exports.process=process,exports.ajax1=ajax_comment,exports.ajax2=ajax_comment_del;