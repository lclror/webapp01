function ajax(e){e.post("/ajax/book/admin/save",upload.single("posters_file"),function(e,t){var n=e.body.nav,r=e.body.id,i=e.body.image,s=e.body.title,o=e.body.author,u=e.body.publisher,a=e.body.ISBN,f=e.body.pubdate,l=e.body.pages,c=e.body.binding,h=e.body.price,p=e.body.summary,d=e.body.author_intro,v=e.body.catalog,m=e.body.category,g=m.split(","),y={id:r,image:i,title:s,author:o,publisher:u,ISBN:a,pubdate:f,pages:l,binding:c,price:h,summary:p,author_intro:d,catalog:v,category:g,pv:0};n!=""&&(y._id=ObjectId(n)),coll_booklist.save(y,function(e,n){console.log(n.result),e?t.send({status:"error"}):t.send({status:"success"})})})}function routerall(e){ajax(e);var t=cheerio.load(html,{decodeEntities:!1});e.get("/book/admin01/save",function(e,t,n){var r=e.session.adminlogin;r?n():t.redirect("/book")},function(e,n){html=t.html(),n.send(html)});var n=cheerio.load(html,{decodeEntities:!1});e.get("/book/admin01/save/:id",function(e,t){var r=e.params.id;coll_booklist.find({_id:ObjectId(r)}).toArray(function(e,i){n("#booksave>nav").text(r);var s=i[0].id,o=i[0].image,u=i[0].title,a=i[0].author,f=i[0].publisher,l=i[0].ISBN,c=i[0].pubdate,h=i[0].pages;binding=i[0].binding,price=i[0].price,summary=i[0].summary,author_intro=i[0].author_intro,catalog=i[0].catalog,category=i[0].category;var p=n("#booksave>form>input");p.eq(0).val(s),p.eq(1).val(o),p.eq(2).val(u),p.eq(3).val(a),p.eq(4).val(f),p.eq(5).val(l),p.eq(6).val(c),p.eq(7).val(h),p.eq(8).val(binding),p.eq(9).val(price),n("#booksave>form>textarea").eq(0).val(summary),n("#booksave>form>textarea").eq(1).val(author_intro),n("#booksave>form>textarea").eq(2).val(catalog),n("#booksave>ul>li").each(function(e,t){var r=n(this),i=r.text();for(var e in category){var s=category[e];i==s?r.addClass("selected"):r.removeClass("selected")}}),i[0].pv>14?(n("#booksave form button").addClass("hide"),n("#booksave form p").removeClass("hide")):(n("#booksave form button").removeClass("hide"),n("#booksave form p").addClass("hide")),html=n.html(),t.send(html)})})}var mongoskin=require("mongoskin"),ObjectId=mongoskin.ObjectId,mongodb_array=require("../mongodb/mongodb_array"),coll_booklist=mongodb_array.collection("booklist"),cheerio=require("cheerio"),html='<!doctype html><html lang="zh-CN"/><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"/><meta name="renderer" content="webkit"/><!--[if lte IE 9]><script src="http://apps.bdimg.com/libs/html5shiv/r29/html5.min.js"></script><![endif]--><title>booksave</title><link rel="stylesheet" href="../../../lib/xxxbase.css"><link rel="stylesheet" href="../../../P_book/P_booksave.css"><script src="../../../lib/jquery.js"></script></head><body><section id="booksave">	<nav></nav>	<h1>book 后台录入页</h1>	<label class="marright3">豆瓣图书 id:</label><input type="text" class="input1 form-input marright2"/>	<button class="btn1 btn-opacity ">获取jsonp</button>	<ul>		<li>小说</li> <li>艺术</li> <li>政治军事</li> <li>外语</li> <li>文学</li>		<li>武侠</li> <li>历史</li> <li>动漫手绘</li> <li>名人传记</li> <li>电脑</li>		<li>旅游</li> <li>原创</li> <li>生活</li> <li>自然科学</li> <li>其他</li>	</ul>	<p>标签</p>	<form>		<label for="">id </label><input type="text"><br/>		<label for="">封面 </label><input type="text"><br/>		<label for="">标题 </label><input type="text"><br/>		<label for="">作者 </label><input type="text"><br/>		<label for="">出版社 </label><input type="text"><br/>		<label for="">ISBN </label><input type="text"><br/>		<label for="">发布日期 </label><input type="text"><br/>		<label for="">页数 </label><input type="text"><br/>		<label for="">装订 </label><input type="text"><br/>		<label for="">价钱 </label><input type="text"><br/>		<label for="">封面上传 </label><input disabled type="file"><br/>		<label class="des" for="">概要 </label><textarea name="" id="" cols="45" rows="7"></textarea><br/>		<label class="des" for="">作者简介 </label><textarea name="" id="" cols="45" rows="7"></textarea><br/>		<label class="des" for="">目录 </label><textarea name="" id="" cols="45" rows="7"></textarea><br/>		<button type="button">录入</button>		<p class="hide">[未获得录入权限]</p>	</form></section></body><script src="../../../lib/require.js" data-main="../../../P_book/P_booksave.js"></script></html>',multer=require("multer"),upload=multer({dest:"./P_book/img"});exports.routerall=routerall;